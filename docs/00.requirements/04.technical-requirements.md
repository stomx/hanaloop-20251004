# 기술 요구사항

## 개요

이 문서는 탄소 배출 대시보드 개발에 필요한 기술 스택, 아키텍처, 제약사항 및 구현 가이드라인을 정의합니다.

## 필수 기술 스택

### 1. 프레임워크 및 라이브러리

### Next.js 14+ (App Router)

- App Router 사용 (Pages Router 금지)
- Server Components와 Client Components 적절히 분리
- Route Groups, Parallel Routes 등 필요시 활용
- `app/` 디렉토리 구조 사용

### React 18+

- Concurrent Features (Suspense, Transitions 등)
- Hooks 기반 컴포넌트 작성
- Server Components와 Client Components 혼용

### TypeScript

- 엄격한 타입 체킹 (`strict: true`)
- 모든 컴포넌트, 함수에 타입 지정
- `any` 사용 최소화
- 타입 정의 파일 별도 관리 (`types/` 디렉토리)

### 2. 스타일링

**허용되는 접근 방식**:

- **Tailwind CSS** (추천)
  - 유틸리티 우선 접근
  - 커스텀 테마 설정 (색상, 폰트, 간격 등)
  - `tailwind.config.js`에서 디자인 토큰 관리
  
- **CSS Modules**
  - 컴포넌트별 스타일 캡슐화
  - `.module.css` 파일 사용
  
- **Styled Components / Emotion**
  - CSS-in-JS 방식
  - 동적 스타일링 필요 시

**제약사항**:

- ❌ 무거운 UI 라이브러리 금지 (Material-UI, Ant Design)
- ✅ 소형 유틸리티/headless UI 허용 (Radix UI, Headless UI, shadcn/ui)

### 3. 상태 관리

### 옵션 1: 전역 상태 라이브러리

- **Zustand** (추천)

  ```typescript
  // stores/useEmissionsStore.ts
  import create from 'zustand';
  
  interface EmissionsStore {
    companies: Company[];
    filters: FilterState;
    setCompanies: (companies: Company[]) => void;
    setFilters: (filters: Partial<FilterState>) => void;
  }
  
  export const useEmissionsStore = create<EmissionsStore>((set) => ({
    companies: [],
    filters: {},
    setCompanies: (companies) => set({ companies }),
    setFilters: (filters) => set((state) => ({ 
      filters: { ...state.filters, ...filters } 
    })),
  }));
  ```

- **Redux Toolkit**
  - 복잡한 상태 로직이 필요한 경우
  - RTK Query로 데이터 페칭 통합

### 옵션 2: React Context + Custom Hooks

```typescript
// contexts/EmissionsContext.tsx
'use client';

import { createContext, useContext, useState } from 'react';

interface EmissionsContextType {
  companies: Company[];
  setCompanies: (companies: Company[]) => void;
}

const EmissionsContext = createContext<EmissionsContextType | undefined>(undefined);

export function EmissionsProvider({ children }: { children: React.ReactNode }) {
  const [companies, setCompanies] = useState<Company[]>([]);
  
  return (
    <EmissionsContext.Provider value={{ companies, setCompanies }}>
      {children}
    </EmissionsContext.Provider>
  );
}

export function useEmissions() {
  const context = useContext(EmissionsContext);
  if (!context) throw new Error('useEmissions must be used within EmissionsProvider');
  return context;
}
```text

**상태 분리 원칙**:

- UI 상태 (모달 열림/닫힘, 드로어 상태): 로컬 useState
- 필터 상태: URL Query Params 또는 전역 상태
- 서버 데이터: React Query, SWR, 또는 Next.js 데이터 페칭

### 4. 데이터 페칭

**옵션**:

- **React Query / TanStack Query** (추천)

  ```typescript
  import { useQuery, useMutation } from '@tanstack/react-query';
  
  export function useCompanies() {
    return useQuery({
      queryKey: ['companies'],
      queryFn: fetchCompanies,
      staleTime: 5 * 60 * 1000, // 5분
    });
  }
  
  export function useCreatePost() {
    return useMutation({
      mutationFn: createOrUpdatePost,
      onSuccess: () => {
        queryClient.invalidateQueries({ queryKey: ['posts'] });
      },
    });
  }
  ```

- **SWR**

  ```typescript
  import useSWR from 'swr';
  
  export function useCompanies() {
    const { data, error, isLoading } = useSWR('/api/companies', fetchCompanies);
    return { companies: data, error, isLoading };
  }
  ```

- **Next.js 네이티브**
  - Server Components에서 직접 fetch
  - `fetch` API의 캐싱 옵션 활용

### 5. 차트 라이브러리

**추천 라이브러리**:

- **Recharts** (React 네이티브, 추천)
  - 선언적 API
  - 커스터마이징 용이
  - TypeScript 지원 우수

- **Chart.js + react-chartjs-2**
  - 성능 좋음
  - 다양한 차트 타입

- **D3.js** (고급)
  - 완전한 커스터마이징
  - 러닝 커브 높음

**기본 차트 구현 예시** (Recharts):

```typescript
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

export function EmissionsLineChart({ data }: { data: ChartData[] }) {
  return (
    <LineChart width={600} height={300} data={data}>
      <CartesianGrid strokeDasharray="3 3" />
      <XAxis dataKey="month" />
      <YAxis />
      <Tooltip />
      <Legend />
      <Line type="monotone" dataKey="emissions" stroke="#3b82f6" />
    </LineChart>
  );
}
```text

## 가짜 백엔드 구현

### API 모듈 (`lib/api.ts`)

네트워크 I/O, 지연, 실패를 시뮬레이션하는 모듈:

```typescript
// lib/api.ts
import { countries as seedCountries } from './seed-data/countries';
import { companies as seedCompanies } from './seed-data/companies';
import { posts as seedPosts } from './seed-data/posts';
import type { Country, Company, Post } from '@/types';

// In-memory data storage (클라이언트 사이드)
let _countries: Country[] = [...seedCountries];
let _companies: Company[] = [...seedCompanies];
let _posts: Post[] = [...seedPosts];

// Utility functions
const delay = (ms: number) => new Promise(res => setTimeout(res, ms));
const jitter = () => 200 + Math.random() * 600; // 200-800ms
const maybeFail = () => Math.random() < 0.15; // 15% 실패율

// CRUD Operations

export async function fetchCountries(): Promise<Country[]> {
  await delay(jitter());
  return _countries;
}

export async function fetchCompanies(): Promise<Company[]> {
  await delay(jitter());
  return _companies;
}

export async function fetchPosts(): Promise<Post[]> {
  await delay(jitter());
  return _posts;
}

export async function fetchPostById(id: string): Promise<Post | null> {
  await delay(jitter());
  return _posts.find(p => p.id === id) || null;
}

export async function createOrUpdatePost(
  post: Omit<Post, 'id'> & { id?: string }
): Promise<Post> {
  await delay(jitter());
  
  if (maybeFail()) {
    throw new Error('Save failed - please try again');
  }
  
  if (post.id) {
    // Update existing
    const index = _posts.findIndex(p => p.id === post.id);
    if (index === -1) throw new Error('Post not found');
    
    const updated = { ...post, id: post.id } as Post;
    _posts[index] = updated;
    return updated;
  } else {
    // Create new
    const created: Post = {
      ...post,
      id: crypto.randomUUID(),
    };
    _posts = [..._posts, created];
    return created;
  }
}

export async function deletePost(id: string): Promise<void> {
  await delay(jitter());
  
  if (maybeFail()) {
    throw new Error('Delete failed - please try again');
  }
  
  const index = _posts.findIndex(p => p.id === id);
  if (index === -1) throw new Error('Post not found');
  
  _posts = _posts.filter(p => p.id !== id);
}
```text

### 시드 데이터 구조

```text
lib/
  seed-data/
    countries.ts
    companies.ts
    posts.ts
  api.ts
```

**countries.ts**:

```typescript
import type { Country } from '@/types';

export const countries: Country[] = [
  { code: 'US', name: 'United States' },
  { code: 'DE', name: 'Germany' },
  { code: 'KR', name: 'South Korea' },
  { code: 'JP', name: 'Japan' },
];
```

## 프로젝트 구조

추천 디렉토리 구조:

```text
hanaloop-emissions-dashboard/
├── app/                          # Next.js App Router
│   ├── layout.tsx               # Root layout
│   ├── page.tsx                 # Dashboard home
│   ├── companies/
│   │   ├── page.tsx            # Companies list
│   │   └── [id]/
│   │       └── page.tsx        # Company detail
│   └── posts/
│       ├── page.tsx            # Posts list
│       ├── new/
│       │   └── page.tsx        # Create post
│       └── [id]/
│           └── edit/
│               └── page.tsx    # Edit post
├── components/                   # React components
│   ├── ui/                      # Reusable UI components
│   │   ├── Button.tsx
│   │   ├── Card.tsx
│   │   ├── Input.tsx
│   │   └── ...
│   ├── charts/                  # Chart components
│   │   ├── EmissionsLineChart.tsx
│   │   ├── CompanyBarChart.tsx
│   │   └── SourcePieChart.tsx
│   ├── layout/                  # Layout components
│   │   ├── Navbar.tsx
│   │   ├── Sidebar.tsx
│   │   └── Header.tsx
│   └── features/                # Feature-specific components
│       ├── dashboard/
│       ├── companies/
│       └── posts/
├── lib/                         # Utility functions
│   ├── api.ts                  # Fake backend API
│   ├── seed-data/
│   │   ├── countries.ts
│   │   ├── companies.ts
│   │   └── posts.ts
│   ├── utils.ts                # Helper functions
│   └── hooks/                  # Custom hooks
│       ├── useCompanies.ts
│       ├── usePosts.ts
│       └── useFilters.ts
├── types/                       # TypeScript type definitions
│   └── index.ts
├── stores/                      # State management (if using Zustand/Redux)
│   └── useEmissionsStore.ts
├── styles/                      # Global styles
│   └── globals.css
├── public/                      # Static assets
└── tests/                       # Test files
    ├── unit/
    └── integration/
```

## 성능 최적화

### 1. 렌더링 최적화

**React.memo**:

```typescript
export const ChartCard = React.memo(({ data }: ChartCardProps) => {
  return <div>{/* chart content */}</div>;
});
```

**useMemo / useCallback**:

```typescript
const filteredData = useMemo(() => {
  return companies.filter(c => filters.countries.includes(c.country));
}, [companies, filters.countries]);

const handleFilterChange = useCallback((newFilters: Filters) => {
  setFilters(newFilters);
}, []);
```

### 2. 코드 스플리팅

**Dynamic Imports**:

```typescript
import dynamic from 'next/dynamic';

const HeavyChart = dynamic(() => import('@/components/charts/HeavyChart'), {
  loading: () => <ChartSkeleton />,
  ssr: false, // 클라이언트에서만 로드
});
```

### 3. 데이터 캐싱

- React Query / SWR의 staleTime, cacheTime 설정
- Next.js의 fetch 캐싱 옵션 활용

## 테스팅

### 단위 테스트 (Vitest / Jest)

```typescript
// __tests__/utils/calculateTotalEmissions.test.ts
import { describe, it, expect } from 'vitest';
import { calculateTotalEmissions } from '@/lib/utils';

describe('calculateTotalEmissions', () => {
  it('should sum up all emissions correctly', () => {
    const company = {
      id: 'c1',
      name: 'Test',
      country: 'US',
      emissions: [
        { yearMonth: '2024-01', source: 'gasoline', emissions: 100 },
        { yearMonth: '2024-02', source: 'diesel', emissions: 50 },
      ],
    };
    
    expect(calculateTotalEmissions(company)).toBe(150);
  });
});
```

### 컴포넌트 테스트 (React Testing Library)

```typescript
import { render, screen } from '@testing-library/react';
import { CompanyCard } from '@/components/CompanyCard';

describe('CompanyCard', () => {
  it('renders company name and country', () => {
    const company = { id: 'c1', name: 'Acme Corp', country: 'US', emissions: [] };
    render(<CompanyCard company={company} />);
    
    expect(screen.getByText('Acme Corp')).toBeInTheDocument();
    expect(screen.getByText('US')).toBeInTheDocument();
  });
});
```

### E2E 테스트 (Playwright - 선택사항)

```typescript
import { test, expect } from '@playwright/test';

test('should display dashboard', async ({ page }) => {
  await page.goto('/');
  await expect(page.locator('h1')).toContainText('Dashboard');
});
```

## 에러 처리 및 로깅

### 에러 바운더리

```typescript
// components/ErrorBoundary.tsx
'use client';

import { Component, ReactNode } from 'react';

interface Props {
  children: ReactNode;
  fallback?: ReactNode;
}

interface State {
  hasError: boolean;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError() {
    return { hasError: true };
  }

  render() {
    if (this.state.hasError) {
      return this.props.fallback || <div>Something went wrong</div>;
    }

    return this.props.children;
  }
}
```

### Try-Catch 및 토스트

```typescript
const handleSave = async () => {
  try {
    await createOrUpdatePost(postData);
    toast.success('Post saved successfully');
  } catch (error) {
    console.error('Failed to save post:', error);
    toast.error('Failed to save post. Please try again.');
  }
};
```

## 배포

### Vercel (추천)

- Next.js 최적화
- 자동 CI/CD
- 환경 변수 관리

### 기타 플랫폼

- Netlify
- AWS Amplify
- Railway

## 환경 설정

### `.env.local` 예시

```bash
NEXT_PUBLIC_APP_NAME=HanaLoop Emissions Dashboard
NEXT_PUBLIC_API_BASE_URL=http://localhost:3000
```

## 패키지 설치 예시

```bash
# 프로젝트 생성
npx create-next-app@latest hanaloop-emissions-dashboard --typescript --tailwind --app

# 상태 관리
npm install zustand
# 또는
npm install @reduxjs/toolkit react-redux

# 데이터 페칭
npm install @tanstack/react-query
# 또는
npm install swr

# 차트
npm install recharts
npm install @types/recharts -D

# UI 컴포넌트
npm install @radix-ui/react-dropdown-menu @radix-ui/react-dialog
# 또는 shadcn/ui
npx shadcn-ui@latest init

# 유틸리티
npm install clsx tailwind-merge
npm install date-fns

# 테스팅
npm install -D vitest @testing-library/react @testing-library/jest-dom
npm install -D @playwright/test

# 린팅 & 포매팅
npm install -D eslint prettier eslint-config-prettier
```

## 개발 워크플로우

1. **초기 설정**
   - Next.js 프로젝트 생성
   - 타입 정의 작성
   - 시드 데이터 및 가짜 API 구현

2. **컴포넌트 개발**
   - UI 컴포넌트 라이브러리 구축
   - 레이아웃 컴포넌트 작성
   - 차트 컴포넌트 구현

3. **페이지 구현**
   - 대시보드 홈
   - 회사 목록 및 상세
   - 포스트 CRUD

4. **상태 관리 통합**
   - 전역 상태 설정
   - 데이터 페칭 로직 구현

5. **스타일링 및 반응형**
   - 디자인 시스템 적용
   - 반응형 레이아웃 구현

6. **테스트 및 최적화**
   - 단위 테스트 작성
   - 성능 최적화
   - 에러 처리 강화

## 제약사항 요약

### 필수 (MUST)

- ✅ Next.js 14+ (App Router)
- ✅ React 18+
- ✅ TypeScript
- ✅ 가짜 백엔드 구현 (지연, 실패 시뮬레이션)

### 금지 (MUST NOT)

- ❌ Pages Router 사용
- ❌ 무거운 UI 라이브러리 (MUI, Ant Design)
- ❌ JavaScript (타입스크립트 필수)

### 권장 (SHOULD)

- ✅ 상태 관리 라이브러리 또는 Context API
- ✅ React Query / SWR
- ✅ Tailwind CSS
- ✅ 테스트 작성

### 선택 (MAY)

- ✅ E2E 테스트
- ✅ 고급 애니메이션
- ✅ 추가 기능 구현
